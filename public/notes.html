<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="./img/icons/64x64.png">
    <link rel="apple-touch-icon" sizes="64x64" href="./img/icons/64x64.png">
    <link rel="manifest" href="./manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700" rel="stylesheet" />
    <link href="./css/main.css" rel="stylesheet" />
    <title>Notes â€“ Coragon</title>
</head>

<body id="notes-page">
    <nav class="navbar navbar-vertical fixed-left navbar-expand-md navbar-light" id="sidenav-main">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" name="navbarFadeIn">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand pr-3" href="./">
                <img src="./img/logo.png" alt="Coragon Logo" id="navbar-brand-img">
            </a>
            <div class="navbar-collapse" id="navcol">
                <div class="navbar-collapse-header d-md-none">
                    <div class="row">
                        <div class="col-6 collapse-brand">
                            <a href="./">
                                <img src="./img/logo.png" alt="Coragon Logo" id="navbar-brand-img">
                            </a>
                        </div>
                        <div class="col-6 collapse-close align-self-center">
                            <button class="navbar-toggler" type="button" name="navbarFadeOut">
                                <img title="Close navbar" src='img/svg/close.svg'>
                            </button>
                        </div>
                    </div>
                </div>
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="./">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="./events">Events</a></li>
                    <li class="nav-item"><a class="nav-link" href="./goals">Goals</a></li>
                    <li class="nav-item"><a class="nav-link active" href="./notes">Notes</a></li>
                </ul>
                <hr class="my-3">
                <ul class="navbar-nav mb-md-3">
                    <li class="nav-item"><a id="logout" class="nav-link" href="javascript:void(0)">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="main-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <h3 class="page-nav">Notes</h3>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div id="notes-wrapper" class="mt-4">
                        <div id="newNote">
                            <form id="newNoteForm" class="form-group textbox mx-auto" name="note-form">
                                <textarea class="form-control py-3 px-4" name="newNoteTextarea" placeholder="Title
Write new note here ..." rows="2" spellcheck="false" required></textarea>
                                <div class="save">
                                    <span>Close</span>
                                </div>
                            </form>
                        </div>
                        <div id="notes" class='small mt-3 py-3 px-4 bg-white text-center'>Loading data ...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autosize.js/4.0.2/autosize.min.js"></script>
    <script src="./js/main.js"></script>
    <script>

    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            
            let notesRef = fs.collection("users").doc(user.uid).collection('notes');
            let osgl = window.OneSignal || [];
            let newnote = document.forms.newNoteForm;
            let ta = newnote.elements.newNoteTextarea;
            let save = newnote.lastElementChild;

            sessionStorage.setItem("firebase-uid", user.uid);

            osgl.push(()=> {
                osgl.init({ appId: "12fe1f4e-c50f-4321-961a-3fc7a36b7983" });
                osgl.getNotificationPermission(permission => {
                    if (permission === "granted") osgl.getUserId(userId => {
                        fs.collection("users").doc(user.uid).set({
                            onesignal_devices: firebase.firestore.FieldValue.arrayUnion(userId)
                        }, {merge: true});
                        sessionStorage.setItem("onesignal-user-id", userId);
                    });
                });
            });
            
            notesRef.orderBy('pin','desc').onSnapshot(function(data){
                let elem = '';
                let cachingData = {};

                if(!data.empty){
                    let noteTitle, noteData;
                    elem += `<ul id='notes' class='list-group list-group-flush'>`;
                    data.forEach(v=>{
                        let d = v.data();
                        let title = d.data.split("\n")[0];
                        let snippet = d.data.split("\n").slice(1).join(" ");
                        elem += `
                            <li class='list-group-item py-3 px-4' data-id='${v.id}'>
                                <div class='header d-flex justify-content-between'>
                                    <span class='name font-weight-bold'>${title}</span>
                                    <span class='actions float-right col-auto pl-2 pr-0'>
                                        <img title='Pin to Top' class='pin' src='img/svg/${d.pin ? "pinned" : "unpinned"}.svg'>
                                        <img title='Delete' class='delete ml-3' src='img/svg/delete.svg'>
                                    </span>
                                </div>
                                <div class='snippet mt-2'>${snippet.length < 150 ? snippet : snippet.substring(0, 150) + " ..."}</div>
                            </li>
                        `;
                        cachingData[v.id] = d;
                    });
                    elem += `</ul>`;
                } else {
                    elem += `<div id='notes' class='small mt-3 py-3 px-4 bg-white text-center'>You don't have a note</div>`;
                }

                document.getElementById("notes").outerHTML = elem;
                sessionStorage.notesData = JSON.stringify(cachingData);
            });

            ta.addEventListener("keyup", function(){
                let display = getComputedStyle(save).display;
                if (display == "none" && this.value !== "") slide(save, {type: "show"});
                if (display != "none" && this.value === "") slide(save, {type: "hide"});
            });

            autosize(ta);

            save.addEventListener("click", () => {
                if(ta.value.replace(/\s/g, '').length > 0){
                    notesRef.add({
                        data: ta.value,
                        pin: false
                    });
                }
                ta.value = "";
                autosize.update(ta);
                slide(save, {type: "hide"});
            });

            document.addEventListener("click", function(evt){
                let id, note;
                let notesDt = JSON.parse(sessionStorage.notesData);
                let t = evt.target;

                if(t && evt.path.some(el => el.id === "notes")){

                    if(t.parentNode.parentNode.parentNode != null && t.parentNode.parentNode.parentNode.hasAttribute("data-id")){
                        id = t.parentNode.parentNode.parentNode.dataset.id;
                        note = notesDt[id];
                    }

                    if (t.classList.contains("pin")) {
                        notesRef.doc(id).update({ pin: !note.pin });

                    } else if (t.classList.contains("delete")) {
                        notesRef.doc(id).delete().then(() => {
                            notif("Notes successfully deleted!", {type: "info", whenUndo: () => {
                                notesRef.doc(id).set(note);
                            }});
                        });

                    } else if (t.id !== "notes") {
                        id = evt.path.find(el => el.hasAttribute("data-id")).dataset.id;
                        let taValue = notesDt[id].data;
                        let editBoxElement = `
                            <div id="note-edit" class="note-edit-overlay">
                                <div class="note-edit-box">
                                    <textarea class="form-control p-4" placeholder="Title\nEdit your note ..." spellcheck="false" required>${taValue}</textarea>
                                    <div class="px-4">
                                        <span class="edit-close my-3 float-right pointer">Close</span>
                                    </div>
                                </div>
                            </div>
                        `;

                        let editBox;

                        document.body.insertAdjacentHTML("beforeend", editBoxElement);
                        editBox = document.getElementById("note-edit");
                        fade(editBox, {type: "show"});

                        let ta = editBox.firstElementChild.firstElementChild;

                        Array.prototype.forEach.call(ta, elem => elem.placeholder = elem.placeholder.replace(/\\n/g, '\n'));

                        autosize(ta);
                        
                        editBox.querySelector(".edit-close").addEventListener("click", () => {
                            if(!!ta.value.replace(/\s/g, '').length) notesRef.doc(id).update({ data: ta.value });
                            fade(editBox, {type: "hide", duration: 600})
                            setTimeout(() => editBox.parentNode.removeChild(editBox), 600);
                        });

                    }
                }
            });

        } else {
            location.href = "./login?ref=notes";
        }
    });

    </script>
</body>

</html>