<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="./img/icons/64x64.png">
    <link rel="apple-touch-icon" sizes="64x64" href="./img/icons/64x64.png">
    <link rel="manifest" href="./manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700" rel="stylesheet" />
    <link href="./style.css" rel="stylesheet" />
    <title>Notes â€“ Coragon</title>
</head>

<body id="notes-page">
    <nav class="navbar navbar-vertical fixed-left navbar-expand-md navbar-light" id="sidenav-main">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" name="navbarFadeIn">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand pr-3" href="./">
                <img src="./img/logo-black.png" alt="Coragon Logo" id="navbar-brand-img">
            </a>
            <div class="navbar-collapse fade hide opacity-0" id="navcol">
                <div class="navbar-collapse-header d-md-none">
                    <div class="row">
                        <div class="col-6 collapse-brand">
                            <a href="./">
                                <img src="./img/logo-black.png" alt="Coragon Logo" id="navbar-brand-img">
                            </a>
                        </div>
                        <div class="col-6 collapse-close align-self-center">
                            <button class="navbar-toggler" type="button" name="navbarFadeOut">
                                <img title="Close navbar" src='img/svg/close.svg'>
                            </button>
                        </div>
                    </div>
                </div>
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="./">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="./events">Events</a></li>
                    <li class="nav-item"><a class="nav-link" href="./goals">Goals</a></li>
                    <li class="nav-item"><a class="nav-link active" href="./notes">Notes</a></li>
                </ul>
                <hr class="my-3">
                <ul class="navbar-nav mb-md-3">
                    <li class="nav-item"><a id="logout" class="nav-link" href="javascript:void(0)">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="main-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <h3 class="page-nav">Notes</h3>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div id="notes-wrapper" class="mt-4">
                        <div id="newNote">
                            <form id="newNoteForm" class="form-group textbox mx-auto" name="note-form">
                                <textarea class="form-control py-3 px-4" placeholder="Title
Write new note here ..." rows="2" spellcheck="false" required></textarea>
                                <div class="save pointer hide opacity-0">Close</div>
                            </form>
                        </div>
                        <div id="notes" class='small mt-3 py-3 px-4 bg-white text-center'>Loading data ...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/autosize@4.0.2/dist/autosize.min.js"></script>
    <script src="./script.js"></script>
    <script>

    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            
            let notesRef = fs.collection("users").doc(user.uid).collection('notes');
            let osgl = window.OneSignal || [];
            let newnote = document.getElementById("newNoteForm");
            let ta = newnote.getElementsByTagName("textarea")[0];
            let save = newnote.getElementsByClassName("save")[0];

            sessionStorage.setItem("firebase-uid", user.uid);

            ta.keyup(function(){
                if($(this).val()!=="") save.slideDown();
                else save.slideUp();
            });

            autosize(ta);

            save.click(function(){
                if(!!ta.val().replace(/\s/g, '').length){
                    notesRef.add({
                        data: ta.val(),
                        pin: false
                    });
                }
                ta.val("");
                autosize.update(ta);
                save.slideUp();
            });

            osgl.push(()=> {
                osgl.init({ appId: "12fe1f4e-c50f-4321-961a-3fc7a36b7983" });
                osgl.getNotificationPermission(permission => {
                    if (permission === "granted") osgl.getUserId(userId => {
                        fs.collection("users").doc(user.uid).set({ onesignal_devices: firebase.firestore.FieldValue.arrayUnion(userId) }, {merge: true});
                        sessionStorage.setItem("onesignal-user-id", userId);
                    });
                });
            });
            
            notesRef.orderBy('pin','desc').onSnapshot(function(data){
                var elem = '';
                var cachingData = {};
                if(!data.empty){
                    var noteTitle, noteData;
                    elem += "<ul id='notes' class='list-group list-group-flush'>";
                    data.forEach(v=>{
                        let d = v.data();
                        let snippet = d.data.split("\n").slice(1).join(" ");
                        elem += "<li class='list-group-item py-3 px-4' data-id='"+v.id+"'>";
                            elem += "<div class='header'>";
                                elem += "<span class='name font-weight-bold'>"+d.data.split("\n")[0]+"</span>";
                                elem += "<span class='actions float-right'>";
                                    elem += "<img title='Pin to Top' class='pin' src='img/svg/"+(d.pin?"pinned":"unpinned")+".svg'>";
                                    elem += "<img title='Delete' class='delete ml-3' src='img/svg/delete.svg'>";
                                elem += "</span>";
                            elem += "</div>";
                            elem += "<div class='snippet mt-2'>";
                                elem += snippet.length<150?snippet:snippet.substring(0,150)+" ...";
                            elem += "</div>";
                        elem += "</li>";
                        cachingData[v.id] = d;
                    });
                    elem += "</ul>";
                } else {
                    elem += "<div id='notes' class='small mt-3 py-3 px-4 bg-white text-center'>You don't have a note</div>";
                }
                $('#notes').replaceWith(elem);
                $("#notes").data("data", cachingData);
            });

            $(document).on("click","#notes li",function(e){
                if(!(e.target.classList.contains("delete") || e.target.classList.contains("pin"))){
                    var dtid = this.getAttribute("data-id");
                    var val = $("#notes").data("data")[dtid].data;
                    $(`
                        <div id="note-edit" class="note-edit-overlay">
                            <div class="note-edit-box">
                                <textarea class="form-control p-4" placeholder="Title\nEdit your note ..." spellcheck="false" required>${val}</textarea>
                                <div class="edit-close pointer py-3 px-4 text-right">Close</div>
                            </div>
                        </div>
                    `).hide().appendTo("body").fadeIn();
                    Array.prototype.forEach.call($("#note-edit textarea"), elem => elem.placeholder = elem.placeholder.replace(/\\n/g, '\n'));
                    autosize($("#note-edit textarea"));
                    $("#note-edit .edit-close").click(function(){
                        if(!!$("#note-edit textarea").val().replace(/\s/g, '').length){
                            notesRef.doc(dtid).update({ data: $("#note-edit textarea").val() });
                        }
                        $("#note-edit").fadeOut("fast", function(){
                            $(this).remove();
                        });
                    });
                }
            });

            $(document).on("click", ".pin", function(){
                var id = $(this).parents("li").attr("data-id");
                notesRef.doc(id).update({ pin: !$("#notes").data("data")[id].pin });
            });

            $(document).on("click", ".delete", function(){
                var id = $(this).parents("li").attr("data-id");
                var expire = new Date(time()*1000+7000);
                document.cookie="notes_"+id+"="+JSON.stringify($("#notes").data("data")[id])+";expires="+expire.toUTCString()+";path=/";
                notesRef.doc(id).delete().then(function(){
                    notif("Notes successfully deleted!", undefined, "info", undefined, function(){
                        notesRef.doc(id).set(JSON.parse(getCookie("notes_"+id)))
                    });
                });
            });

        } else {
            location.href = "./login?ref=notes";
        }
    });

    </script>
</body>

</html>