<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="./img/icons/64x64.png">
    <link rel="apple-touch-icon" sizes="64x64" href="./img/icons/64x64.png">
    <link rel="manifest" href="./manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700" rel="stylesheet" />
    <link href="./style.css" rel="stylesheet" />
    <title>Coragon Dashboard</title>
</head>

<body id="dashboard-page">
    <nav class="navbar navbar-vertical fixed-left navbar-expand-md navbar-light" id="sidenav-main">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" name="navbarFadeIn">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand pr-3" href="./">
                <img src="./img/logo-black.png" alt="Coragon Logo" id="navbar-brand-img">
            </a>
            <div class="navbar-collapse fade hide opacity-0" id="navcol">
                <div class="navbar-collapse-header d-md-none">
                    <div class="row">
                        <div class="col-6 collapse-brand">
                            <a href="./">
                                <img src="./img/logo-black.png" alt="Coragon Logo" id="navbar-brand-img">
                            </a>
                        </div>
                        <div class="col-6 collapse-close align-self-center">
                            <button class="navbar-toggler" type="button" name="navbarFadeOut">
                                <img title="Close navbar" src='img/svg/close.svg'>
                            </button>
                        </div>
                    </div>
                </div>
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active" href="./">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="./events">Events</a></li>
                    <li class="nav-item"><a class="nav-link" href="./goals">Goals</a></li>
                    <li class="nav-item"><a class="nav-link" href="./notes">Notes</a></li>
                </ul>
                <hr class="my-3">
                <ul class="navbar-nav mb-md-3">
                    <li class="nav-item"><a id="logout" class="nav-link" href="javascript:void(0)">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="main-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <h3 class="page-nav">Dashboard</h3>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div id="greetings" class="card rounded-0 mt-4 bg-white p-4 text-muted">
                        <div class="card-header bg-white border-0 p-0 mb-3">
                            <h3>How's it going ?</h3>
                        </div>
                        <div id="user" class="card-body p-0">
                            <h6>Loading user profile ...</h6>
                        </div>
                    </div>
                    <div id="feature" class="card rounded-0 mt-4 bg-white p-4">
                        <div class="events">
                            <h5><a href="./events">Events</a></h5>
                            <p class="text-muted">Schedule your important events</p>
                        </div>
                        <hr class="my-4">
                        <div class="goals">
                            <h5><a href="./goals">Goals</a></h5>
                            <p class="text-muted">Things you wanna achieve soon</p>
                        </div>
                        <hr class="my-4">
                        <div class="notes">
                            <h5><a href="./notes">Notes</a></h5>
                            <p class="text-muted">Keep your personal notes here</p>
                            </button>
                        </div>
                        <hr class="my-4">
                        <div class="export">
                            <select id="exportSelect" class="form-control d-inline-block rounded-0 input-responsive" required>
                                <option value="" disabled selected>Export Data</option>
                                <option value="events">Events</option>
                                <option value="goals">Goals</option>
                                <option value="notes">Notes</option>
                            </select>
                            <textarea id="exportTextarea" class='form-control mt-3 fade hide opacity-0' readonly></textarea>
                        </div>
                        <hr class="my-4">
                        <div class="import">
                            <textarea id="importTextarea" class="form-control mb-3 rounded-0" placeholder="Import data here ..." rows="3"></textarea>
                            <button id="importSubmit" class="btn btn-primary px-3 rounded-0" disabled>Submit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-firestore.js"></script>
    <script src="./script.js"></script>
    <script>

    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {

            let userRef = fs.collection("users").doc(user.uid);
            let osgl = window.OneSignal || [];

            sessionStorage.setItem("firebase-uid", user.uid);

            osgl.push(()=> {
                osgl.init({ appId: "12fe1f4e-c50f-4321-961a-3fc7a36b7983" });
                osgl.getNotificationPermission(permission => {
                    if (permission === "granted") osgl.getUserId(userId => {
                        fs.collection("users").doc(user.uid).set({
                            onesignal_devices: firebase.firestore.FieldValue.arrayUnion(userId)
                        }, {merge: true});
                        sessionStorage.setItem("onesignal-user-id", userId);
                    });
                });
            });
            
            document.getElementById("user").outerHTML = `
                <div id="user" class="card-body row p-0">
                    <div class="col-sm-auto px-3 mb-3 mb-sm-0">
                        <img class="user-photo rounded-circle border" src="${user.photoURL}">
                    </div>
                    <div class="col px-sm-0 px-3 align-self-center">
                        <h5 class="user-name">${user.displayName}</h5>
                        <h6 class="user-email">${user.email}</h6>
                    </div>
                </div>
            `;

            document.getElementById("exportSelect").addEventListener('change', function(){
                let v = this.value;
                let res = {[v]:{}};
                let eta = document.getElementById("exportTextarea");

                eta.value = "Loading data ...";
                eta.style.display = "block";

                setTimeout(() => eta.style.opacity = 1, 10);

                textareaHeightAuto(eta);
                
                userRef.collection(v).get().then(dt=>{
                    if(dt.empty){
                        res = "No data";
                    } else {
                        dt.docs.map(function(val){
                            let dt = val.data();
                            if(dt.hasOwnProperty("date")) dt.date = dt.date.seconds*1000;
                            res[v][val.id] = dt;
                        });
                        res = JSON.stringify(res);
                    }
                    eta.value = res;
                    eta.addEventListener('focus', function(){
                        this.select();
                    });
                    textareaHeightAuto(eta);
                });
            });

            let ita = document.getElementById("importTextarea");
            let isub = document.getElementById("importSubmit");

            textareaHeightAuto(ita);

            ita.addEventListener("keyup", function(){
                isub.disabled = this.value === "" ? true : false;
                this.style.borderColor = null;
            });

            isub.addEventListener("click", function(){
                try {
                    let data = ita.value;
                    if(!!Number(data) || ['','""','0','[]','{}','true','false'].indexOf(data) >= 0) throw new Error();
                    data = JSON.parse(data);
                    if(!Object.keys(data).every(elem => ["events", "goals", "notes"].indexOf(elem) > -1)) throw new Error();
                    for (let [col, colVal] of Object.entries(data)) {
                        if(!colVal || typeof colVal != "object" || Object.keys(colVal).length === 0) throw new Error();
                        for (let [doc, val] of Object.entries(colVal)) {
                            if(val.hasOwnProperty("date")) val.date = firebase.firestore.Timestamp.fromMillis(val.date);
                            userRef.collection(col).doc(doc).set(val,{merge:true});
                        }
                    }
                    notif("Data successfully imported!", undefined, "info");
                } catch(err) {
                    ita.style.borderColor = "#fd8f9a";
                }
            });

        } else {
            location.href = "./login";
        }
    });

    </script>
</body>

</html>